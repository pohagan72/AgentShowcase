{# features/multimedia/templates/multimedia_content.html #}
<style>
    /* Scoped styles for the Multimedia Feature */
    .multimedia-feature-container .feature-description { 
        margin-bottom: 2rem; 
    }

    /* Refined Slider Styling */
    .multimedia-feature-container .blur-slider-group label { 
        display: block; 
        margin-bottom: 0.75rem; 
        font-weight: 600; 
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    .multimedia-feature-container .slider-container { 
        display: flex; 
        align-items: center; 
        gap: 1.5rem; 
        background: rgba(255, 255, 255, 0.5); /* Glassy background */
        padding: 1.25rem;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-sm);
    }

    .multimedia-feature-container .slider-container .form-range { 
        flex-grow: 1; 
        cursor: pointer;
    }

    .multimedia-feature-container .slider-container .slider-label { 
        font-size: 0.8rem; 
        color: var(--text-secondary); 
        font-weight: 600; 
        text-transform: uppercase; 
        letter-spacing: 0.05em;
    }
</style>

<div class="feature-container multimedia-feature-container">
    <!-- Header -->
    <h1><i class="ph ph-aperture"></i> Multimedia AI Tools</h1>

    <!-- Tabs -->
    <div class="feature-tabs">
        <button class="tab-link active" data-target-tab="blurring-tab">
            <i class="ph ph-eye-slash"></i> Facial Blurring
        </button>
        <button class="tab-link" data-target-tab="analytics-tab">
            <i class="ph ph-chart-bar"></i> Image Analytics
        </button>
    </div>

    <!-- ================= BLURRING TAB ================= -->
    <div id="blurring-tab" class="feature-tab-content active-content">
        <p class="feature-description">
            In an era of strict privacy regulations, our facial redaction agent provides an essential layer of automated compliance. By leveraging a highly-optimized computer vision model, this tool delivers fast, accurate PII removal without the overhead of larger generative models.
        </p>
        
        <div class="feature-grid">
            <div class="feature-item">
                <h4><i class="ph ph-scan-dashed" style="color:var(--brand-primary); margin-right:6px; vertical-align:middle;"></i> High-Accuracy Detection</h4>
                <p>Utilizes a neural network trained to identify human faces with precision, minimizing false positives.</p>
            </div>
            <div class="feature-item">
                <h4><i class="ph ph-sliders" style="color:var(--brand-primary); margin-right:6px; vertical-align:middle;"></i> Configurable Privacy</h4>
                <p>Offers a range of strengths, from light blur to fully opaque redaction for GDPR/CCPA compliance.</p>
            </div>
            <div class="feature-item">
                <h4><i class="ph ph-lightning" style="color:var(--brand-primary); margin-right:6px; vertical-align:middle;"></i> Efficient Scale</h4>
                <p>Engineered for high-throughput processing, capable of anonymizing thousands of images efficiently.</p>
            </div>
        </div>

        {% if not gcs_available %}
            <div class="message-item category-error" role="alert">
                <i class="ph ph-warning-circle"></i>
                <strong>Configuration Issue:</strong> Cloud Storage is not available. Image processing is disabled.
            </div>
        {% endif %}

        <form id="blur-upload-form" 
              hx-post="{{ url_for('multimedia.process_multimedia_blur_image_route') }}"
              hx-target="#blurring-results-area"
              hx-swap="innerHTML"
              hx-encoding="multipart/form-data"
              hx-indicator="#blur-start-button .spinner">
            
            <div class="form-group" style="margin-bottom: 2rem;">
                <label for="blur-file-input" id="blur-drop-zone-label" class="drop-zone-style">
                    <i class="ph ph-image"></i>
                    <div>
                        <p>Drag & drop your image here</p>
                        <p class="file-info" id="blur-file-name-display">JPG, PNG, WEBP supported</p>
                    </div>
                </label>
                <input type="file" id="blur-file-input" name="file" accept=".jpg,.jpeg,.png,.webp" style="display: none;" required
                       {% if not gcs_available %}disabled{% endif %}>
            </div>

            <div class="form-group blur-slider-group">
                <label for="blur_strength_slider">Anonymization Strength</label>
                <div class="slider-container">
                    <span class="slider-label">Light</span>
                    <input type="range" id="blur_strength_slider" name="blur_strength" class="form-range" 
                           min="1" max="3" step="1" value="2" 
                           {% if not gcs_available %}disabled{% endif %}>
                    <span class="slider-label">Opaque</span>
                </div>
            </div>
            
            <div class="submit-area" style="margin-top: 2rem;">
                <button type="submit" id="blur-start-button" class="submit-button" disabled>
                    <i class="ph ph-shield-check"></i> Anonymize Image
                    <span class="htmx-indicator spinner"></span>
                </button>
            </div>
        </form>

        <div id="blurring-results-area" class="processing-result" style="margin-top: 2rem; min-height: 150px;"></div>
    </div>

    <!-- ================= ANALYTICS TAB ================= -->
    <div id="analytics-tab" class="feature-tab-content">
        <p class="feature-description">
            This AI Agent leverages a state-of-the-art computer vision model to transform raw pixels into valuable business intelligence, enabling automated content moderation, metadata generation, and data extraction at scale.
        </p>
        
        <div class="feature-grid">
            <div class="feature-item">
                <h4><i class="ph ph-brain" style="color:var(--brand-primary); margin-right:6px; vertical-align:middle;"></i> Contextual Analysis</h4>
                <p>Generates rich, semantic descriptions of the scene, identifying key objects and their relationships.</p>
            </div>
            <div class="feature-item">
                <h4><i class="ph ph-text-t" style="color:var(--brand-primary); margin-right:6px; vertical-align:middle;"></i> Data Digitization</h4>
                <p>Instantly extracts embedded text (OCR), converting visual information into machine-readable data.</p>
            </div>
            <div class="feature-item">
                <h4><i class="ph ph-shield-warning" style="color:var(--brand-primary); margin-right:6px; vertical-align:middle;"></i> Image Moderation</h4>
                <p>Proactively audits images for sensitive material to ensure brand safety and compliance.</p>
            </div>
        </div>

        {% if not gemini_configured %}
            <div class="message-item category-error" role="alert">
                <i class="ph ph-warning-circle"></i>
                <strong>Configuration Issue:</strong> The GenAI service is not available. Image analysis is disabled.
            </div>
        {% endif %}

        <form id="analytics-upload-form"
              hx-post="{{ url_for('multimedia.process_multimedia_analyze_image_route') }}"
              hx-target="#analytics-results-area"
              hx-swap="innerHTML"
              hx-encoding="multipart/form-data"
              hx-indicator="#analytics-start-button .spinner"
              hx-params="not image_data_url">
            
            <input type="hidden" name="image_data_url" id="analytics-image-data-url">

            <div class="form-group" style="margin-bottom: 2rem;">
                <label for="analytics-file-input" id="analytics-drop-zone-label" class="drop-zone-style">
                    <i class="ph ph-magnifying-glass"></i>
                    <div>
                        <p>Drag & drop your image here</p>
                        <p class="file-info" id="analytics-file-name-display">JPG, PNG, WEBP supported</p>
                    </div>
                </label>
                <input type="file" id="analytics-file-input" name="file" accept=".jpg,.jpeg,.png,.webp" style="display: none;" required
                       {% if not gemini_configured %}disabled{% endif %}>
            </div>

            <div class="submit-area">
                <button type="submit" id="analytics-start-button" class="submit-button" disabled>
                    <i class="ph ph-sparkle"></i> Analyze Image
                    <span class="htmx-indicator spinner"></span>
                </button>
            </div>
        </form>

        <div id="analytics-results-area" class="processing-result" style="margin-top: 2rem; min-height: 150px;"></div>
    </div>
</div>

<script>
(function() {
    const multimediaFeatureContainer = document.querySelector('.multimedia-feature-container');
    if (!multimediaFeatureContainer) return;

    // --- Tab Switching Logic ---
    const tabLinks = multimediaFeatureContainer.querySelectorAll('.feature-tabs .tab-link');
    const tabContents = multimediaFeatureContainer.querySelectorAll('.feature-tab-content');
    
    function openMultimediaTab(targetTabId) {
        // 1. Hide all tabs
        tabContents.forEach(tc => { 
            tc.style.display = 'none'; 
            tc.classList.remove('active-content'); 
        });
        
        // 2. Deactivate all links
        tabLinks.forEach(tl => tl.classList.remove('active'));
        
        // 3. Find targets
        const currentTabContent = multimediaFeatureContainer.querySelector('#' + targetTabId);
        const currentTabLink = multimediaFeatureContainer.querySelector(`.feature-tabs .tab-link[data-target-tab="${targetTabId}"]`);
        
        // 4. Activate target
        if (currentTabContent) { 
            currentTabContent.style.display = 'block'; 
            // Slight timeout enables the CSS fade-in animation to trigger
            setTimeout(() => currentTabContent.classList.add('active-content'), 10);
        }
        if (currentTabLink) { currentTabLink.classList.add('active'); }
    }

    tabLinks.forEach(link => {
        link.addEventListener('click', function(event) { 
            event.preventDefault(); 
            const targetTabId = this.dataset.targetTab; 
            if (targetTabId) { openMultimediaTab(targetTabId); } 
        });
    });

    // --- Reusable Drop Zone Logic ---
    function setupDropZone(tabId, dropLabelId, fileInputId, nameDisplayId, btnId) {
        const tab = multimediaFeatureContainer.querySelector(tabId);
        if (!tab) return;
        
        const label = tab.querySelector(dropLabelId);
        const input = tab.querySelector(fileInputId);
        const display = tab.querySelector(nameDisplayId);
        const btn = tab.querySelector(btnId);
        const servicesReady = !input.disabled;

        if (label && input && display && btn) {
            // Drag & Drop visual cues
            label.addEventListener('dragover', (e) => { e.preventDefault(); if(servicesReady) label.classList.add('drag-over'); });
            label.addEventListener('dragleave', () => label.classList.remove('drag-over'));
            
            label.addEventListener('drop', (e) => {
                e.preventDefault();
                if(servicesReady) {
                    label.classList.remove('drag-over');
                    if (e.dataTransfer.files.length > 0) {
                        input.files = e.dataTransfer.files;
                        // Manually trigger change event
                        input.dispatchEvent(new Event('change'));
                    }
                }
            });

            // Handle file selection
            input.addEventListener('change', () => {
                if (input.files.length > 0) {
                    display.textContent = input.files[0].name;
                    // Styling for selected state
                    display.style.color = 'var(--brand-primary)';
                    display.style.fontWeight = '600';
                    label.classList.add('file-selected');
                    btn.disabled = false;
                } else {
                    display.textContent = 'JPG, PNG, WEBP supported';
                    display.style.color = '';
                    display.style.fontWeight = '';
                    label.classList.remove('file-selected');
                    btn.disabled = true;
                }
            });
        }
    }

    // Initialize both drop zones
    setupDropZone('#blurring-tab', '#blur-drop-zone-label', '#blur-file-input', '#blur-file-name-display', '#blur-start-button');
    setupDropZone('#analytics-tab', '#analytics-drop-zone-label', '#analytics-file-input', '#analytics-file-name-display', '#analytics-start-button');
})();
</script>