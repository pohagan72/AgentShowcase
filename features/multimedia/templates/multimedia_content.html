{# features/multimedia/templates/multimedia_content.html #}
<div class="feature-container multimedia-feature-container">
    <h1><i class="fas fa-photo-video"></i> Multimedia AI Tools</h1>

    <div class="feature-tabs">
        <button class="tab-link active" data-target-tab="blurring-tab">
            <i class="fas fa-eye-slash"></i> Facial Blurring
        </button>
        <button class="tab-link" data-target-tab="analytics-tab">
            <i class="fas fa-chart-bar"></i> Image Analytics
        </button>
    </div>

    <!-- Tab Content for Blurring -->
    <div id="blurring-tab" class="feature-tab-content active-content">
        <h2><i class="fas fa-eye-slash"></i> AI Agent for Facial Blurring</h2>
        <p class="feature-description" style="margin-bottom: 2rem;">
            The AI Agent for facial blurring uses a Convolutional Neural Network to identify what is most likely a human face in an image, and then applies an opaque graphical overlay. While the code to implement this AI Agent was developed with GenAI, it is not a GenAI application.
        </p>

        {% if not gcs_available %}
            <div class="message-item category-error" role="alert">
                <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                <strong>Configuration Issue:</strong> Google Cloud Storage is not available. Image processing is disabled.
            </div>
        {% endif %}

        <div class="blurring-controls">
            <form id="blur-upload-form" 
                  hx-post="{{ url_for('process_multimedia_blur_image_route') }}"
                  hx-target="#blurring-results-area"
                  hx-swap="innerHTML"
                  hx-encoding="multipart/form-data"
                  hx-indicator="#blur-start-button .spinner">
                
                <div class="blur-input-area"> 
                    <div class="form-group drop-zone-group">
                        <label for="blur-file-input" id="blur-drop-zone-label" class="drop-zone-style">
                            <p style="margin:0 0 5px 0; font-size: 1.0em; color: #333;">Drag & drop your image (JPG, PNG, WEBP) here, or click to select.</p>
                            <p id="blur-file-name-display" style="margin-top:5px; color: #555; font-weight: normal;">No file selected</p> 
                        </label>
                        <input type="file" id="blur-file-input" name="file" accept=".jpg,.jpeg,.png,.webp" style="display: none;" required
                               {% if not gcs_available %}disabled{% endif %}>
                    </div>

                    <div class="form-group blur-slider-group">
                        <label for="blur_strength_slider" class="blur-slider-label">Blur Strength:</label>
                        <div class="vertical-slider-container">
                            <span>Light</span>
                            <input type="range" id="blur_strength_slider" name="blur_strength" class="form-range vertical-slider" 
                                   orient="vertical"
                                   min="1" max="3" step="1" value="2" 
                                   {% if not gcs_available %}disabled{% endif %}>
                            <span>Heavy</span>
                        </div>
                    </div>
                </div>

                <button type="submit" id="blur-start-button" class="submit-button" {% if not gcs_available %}disabled{% endif %}>
                    <i class="fas fa-cogs"></i> Blur Image
                    <span class="htmx-indicator spinner"></span>
                </button>
            </form>
        </div>

        <div id="blurring-results-area" class="processing-result" style="margin-top: 2rem; min-height: 150px;">
            <p><i>Processed images will appear here.</i></p>
        </div>
    </div>

    <!-- Tab Content for Image Analytics -->
    <div id="analytics-tab" class="feature-tab-content">
        {% include 'multimedia/templates/_image_analytics_placeholder.html' %}
    </div>
</div>

<script>
(function() {
    const multimediaFeatureContainer = document.querySelector('.multimedia-feature-container');
    if (!multimediaFeatureContainer) return;

    // --- Tab Switching Logic ---
    const tabLinks = multimediaFeatureContainer.querySelectorAll('.feature-tabs .tab-link');
    const tabContents = multimediaFeatureContainer.querySelectorAll('.feature-tab-content');

    function openMultimediaTab(targetTabId) {
        tabContents.forEach(tc => { 
            tc.style.display = 'none'; 
            tc.classList.remove('active-content'); 
        });
        tabLinks.forEach(tl => tl.classList.remove('active'));
        
        const currentTabContent = multimediaFeatureContainer.querySelector('#' + targetTabId);
        const currentTabLink = multimediaFeatureContainer.querySelector(`.feature-tabs .tab-link[data-target-tab="${targetTabId}"]`);
        
        if (currentTabContent) { 
            currentTabContent.style.display = 'block'; 
            currentTabContent.classList.add('active-content'); 
        }
        if (currentTabLink) { 
            currentTabLink.classList.add('active'); 
        }
    }

    tabLinks.forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault();
            const targetTabId = this.dataset.targetTab;
            if (targetTabId) {
                openMultimediaTab(targetTabId);
            }
        });
    });

    // --- Facial Blurring Tab Logic ---
    const blurringTabContainer = multimediaFeatureContainer.querySelector('#blurring-tab');
    if (blurringTabContainer) {
        const dropZoneLabel = blurringTabContainer.querySelector('#blur-drop-zone-label');
        const fileInput = blurringTabContainer.querySelector('#blur-file-input');
        const fileNameDisplay = blurringTabContainer.querySelector('#blur-file-name-display');

        if (dropZoneLabel && fileInput && fileNameDisplay) {
            dropZoneLabel.addEventListener('dragover', (e) => { e.preventDefault(); if (fileInput.disabled) return; dropZoneLabel.classList.add('drag-over');});
            dropZoneLabel.addEventListener('dragleave', () => { if (fileInput.disabled) return; dropZoneLabel.classList.remove('drag-over');});
            dropZoneLabel.addEventListener('drop', (e) => {
                e.preventDefault(); if (fileInput.disabled) return;
                dropZoneLabel.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            });

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
                    const validExtensions = ['.jpg', '.jpeg', '.png', '.webp'];
                    const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

                    if (allowedTypes.includes(file.type) || validExtensions.includes(fileExt)) {
                        fileNameDisplay.innerHTML = `<strong>${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)} MB) <span class="remove-file-link" style="cursor:pointer; color:red; margin-left:5px;">Ã— Remove</span>`;
                        fileNameDisplay.style.fontWeight = 'bold';
                        fileNameDisplay.style.color = '#333';

                        const removeLink = fileNameDisplay.querySelector('.remove-file-link');
                        if (removeLink) {
                            removeLink.addEventListener('click', function(e_remove) {
                                e_remove.stopPropagation(); 
                                fileInput.value = ''; 
                                const changeEvent = new Event('change', { bubbles: true });
                                fileInput.dispatchEvent(changeEvent);
                            });
                        }
                        dropZoneLabel.classList.add('file-selected'); 
                    } else {
                        alert('Invalid file type. Please upload a JPG, PNG, or WEBP image.');
                        fileInput.value = ''; 
                        const changeEvent = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(changeEvent);
                    }
                } else {
                    fileNameDisplay.textContent = 'No file selected';
                    fileNameDisplay.style.fontWeight = 'normal';
                    fileNameDisplay.style.color = '#555';
                    dropZoneLabel.classList.remove('file-selected');
                }
            });
        }
    }
})();

window.addEventListener('dragover', (e) => { e.preventDefault(); });
window.addEventListener('drop', (e) => { e.preventDefault(); });
</script>