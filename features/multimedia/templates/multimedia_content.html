{# features/multimedia/templates/multimedia_content.html #}
<style>
    /* --- SCOPED CSS FOR MULTIMEDIA --- */
    .media-wrapper { max-width: 900px; margin: 0 auto; }

    /* CRITICAL FIX: Tab Visibility Logic (Local Fallback) */
    .feature-tab-content {
        display: none !important; /* Hide by default */
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    .feature-tab-content.active-content {
        display: block !important; /* Show when active */
        opacity: 1;
        animation: fadeIn 0.4s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* 1. HEADER */
    .media-header { margin-bottom: 2rem; }
    .media-header h1 { 
        display: flex; align-items: center; gap: 12px; 
        font-size: 1.8rem; margin-bottom: 1rem; color: var(--text-primary); letter-spacing: -0.02em;
    }
    
    /* Image Header Styling */
    .media-header h1 img {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .media-header p { font-size: 1.05rem; color: var(--text-secondary); max-width: 700px; line-height: 1.6; }

    /* 2. INFO GRID */
    .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2.5rem; }
    .info-card { 
        background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; 
        transition: all 0.2s ease; display: flex; flex-direction: column; gap: 0.5rem;
    }
    .info-card:hover { background: #ffffff; border-color: var(--brand-primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
    
    .info-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 0.25rem; font-weight: 700; color: var(--text-primary); }
    .info-card-header i { font-size: 1.4rem; color: var(--brand-primary); flex-shrink: 0; }
    .info-card p { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.5; margin: 0; }

    /* 3. CONTROL PANEL */
    .control-panel {
        background: #ffffff; border: 1px solid var(--border-subtle); border-radius: 12px;
        box-shadow: var(--shadow-md); overflow: hidden; margin-bottom: 2rem;
    }

    .cp-upload-area {
        background: #f8fafc; padding: 3rem 2rem; border-bottom: 1px solid var(--border-subtle);
        transition: background 0.2s; display: flex; justify-content: center;
    }
    .drop-zone-active { background: #eff6ff !important; }

    .upload-label {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        width: 100%; border: 2px dashed #cbd5e1; border-radius: 8px; padding: 3rem 2rem;
        text-align: center; cursor: pointer; transition: all 0.2s;
    }
    .upload-label:hover { border-color: var(--brand-primary); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
    .upload-label i { font-size: 3rem; color: #94a3b8; margin-bottom: 1rem; transition: color 0.2s; }
    .upload-label h5 { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; margin-top: 0; }
    .upload-label .subtext { font-size: 0.9rem; color: var(--text-secondary); }

    .cp-settings-bar {
        padding: 1.5rem 2rem; background: white; display: flex; align-items: center; justify-content: space-between; gap: 2rem;
    }
    
    .loading-status {
        display: flex; align-items: center; gap: 10px; color: var(--brand-primary); font-weight: 600; font-size: 0.9rem;
    }

    @media (max-width: 768px) {
        .info-grid { grid-template-columns: 1fr; }
        .cp-settings-bar { flex-direction: column; align-items: stretch; }
    }
</style>

<div class="media-wrapper feature-container">
    
    <!-- Header -->
    <div class="media-header">
        <h1>
            <img src="{{ url_for('static', filename='images/synzo-visual-analyst-icon.png') }}" 
                 alt="Icon" style="width: 48px; height: 48px; vertical-align: middle; margin-right: 12px;">
            Multimedia AI Tools
        </h1>
        
        <!-- Tabs -->
        <div class="feature-tabs">
            <button class="tab-link active" data-target-tab="blurring-tab">
                <img src="{{ url_for('static', filename='images/tab-icon-blur.png') }}" class="tab-icon-img" alt="Redaction">
                Facial Redaction
            </button>
            <button class="tab-link" data-target-tab="analytics-tab">
                <img src="{{ url_for('static', filename='images/tab-icon-analytics.png') }}" class="tab-icon-img" alt="Analytics">
                Image Analytics
            </button>
        </div>
    </div>

    <!-- BLURRING TAB -->
    <div id="blurring-tab" class="feature-tab-content active-content">
        
        <!-- Info Grid -->
        <div class="info-grid">
            <div class="info-card">
                <div class="info-card-header"><i class="ph ph-scan-dashed"></i><span>High-Accuracy</span></div>
                <p>Utilizes a neural network trained to identify human faces with precision, minimizing false positives.</p>
            </div>
            <div class="info-card">
                <div class="info-card-header"><i class="ph ph-sliders"></i><span>Configurable</span></div>
                <p>Offers a range of strengths, from light blur to fully opaque redaction for GDPR/CCPA compliance.</p>
            </div>
            <div class="info-card">
                <div class="info-card-header"><i class="ph ph-lightning"></i><span>Efficient Scale</span></div>
                <p>Engineered for high-throughput processing, capable of anonymizing thousands of images.</p>
            </div>
        </div>

        <form id="blur-upload-form" 
              hx-post="{{ url_for('multimedia.process_multimedia_blur_image_route') }}"
              hx-target="#blurring-results-area"
              hx-swap="innerHTML"
              hx-encoding="multipart/form-data"
              hx-indicator="#blur-spinner">
            
            <div class="control-panel">
                <div class="cp-upload-area" id="blur-drop-area">
                    <label for="blur-file-input" class="upload-label" id="blur-drop-zone">
                        <i class="ph ph-image"></i>
                        <h5 id="blur-file-name">Click to upload or drag and drop</h5>
                        <span class="subtext">Faces will be redacted automatically</span>
                    </label>
                    <input type="file" id="blur-file-input" name="file" accept=".jpg,.jpeg,.png,.webp" style="display: none;">
                </div>

                <div class="cp-settings-bar">
                    <div style="flex: 1; max-width: 300px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:700; color:#64748b; margin-bottom:8px;">
                            <span>LIGHT BLUR</span><span>OPAQUE</span>
                        </div>
                        <!-- Changing slider auto-submits if file is present -->
                        <input type="range" id="blur_strength_slider" name="blur_strength" min="1" max="3" step="1" value="2" 
                               onchange="if(document.getElementById('blur-file-input').files.length) htmx.trigger(this.form, 'submit')">
                    </div>
                    
                    <div id="blur-spinner" class="loading-status htmx-indicator">
                        <div class="spinner" style="border-top-color: var(--brand-primary); border-left-color: var(--brand-primary);"></div>
                        <span>Processing Faces...</span>
                    </div>
                </div>
            </div>
        </form>
        <div id="blurring-results-area"></div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analytics-tab" class="feature-tab-content">
        
        <!-- Info Grid -->
        <div class="info-grid">
            <div class="info-card">
                <div class="info-card-header"><i class="ph ph-brain"></i><span>Contextual Analysis</span></div>
                <p>Generates rich, semantic descriptions of the scene, identifying key objects and relationships.</p>
            </div>
            <div class="info-card">
                <div class="info-card-header"><i class="ph ph-text-t"></i><span>Data Digitization</span></div>
                <p>Instantly extracts embedded text (OCR), converting visual info into machine-readable data.</p>
            </div>
            <div class="info-card">
                <div class="info-card-header"><i class="ph ph-shield-warning"></i><span>Moderation</span></div>
                <p>Proactively audits images for sensitive material to ensure brand safety.</p>
            </div>
        </div>

        <form id="analytics-upload-form"
              hx-post="{{ url_for('multimedia.process_multimedia_analyze_image_route') }}"
              hx-target="#analytics-results-area"
              hx-swap="innerHTML"
              hx-encoding="multipart/form-data"
              hx-indicator="#analytics-spinner"
              hx-params="not image_data_url">
            
            <input type="hidden" name="image_data_url" id="analytics-image-data-url">

            <div class="control-panel">
                <div class="cp-upload-area" id="analytics-drop-area">
                    <label for="analytics-file-input" class="upload-label" id="analytics-drop-zone">
                        <i class="ph ph-magnifying-glass"></i>
                        <h5 id="analytics-file-name">Click to upload or drag and drop</h5>
                        <span class="subtext">Instant object & text detection</span>
                    </label>
                    <input type="file" id="analytics-file-input" name="file" accept=".jpg,.jpeg,.png,.webp" style="display: none;">
                </div>

                <div class="cp-settings-bar" style="justify-content: flex-end;">
                    <div id="analytics-spinner" class="loading-status htmx-indicator">
                        <div class="spinner" style="border-top-color: var(--brand-primary); border-left-color: var(--brand-primary);"></div>
                        <span>Analyzing Image...</span>
                    </div>
                </div>
            </div>
        </form>
        <div id="analytics-results-area"></div>
    </div>
</div>

<script>
(function() {
    function setupAutoDrop(areaId, labelId, inputId, nameId, formId) {
        const area = document.getElementById(areaId);
        const label = document.getElementById(labelId);
        const input = document.getElementById(inputId);
        const display = document.getElementById(nameId);
        const form = document.getElementById(formId);

        if(!label || !input) return;

        ['dragenter', 'dragover'].forEach(e => label.addEventListener(e, (ev) => { ev.preventDefault(); area.classList.add('drop-zone-active'); label.style.borderColor = 'var(--brand-primary)'; }));
        ['dragleave', 'drop'].forEach(e => label.addEventListener(e, (ev) => { ev.preventDefault(); area.classList.remove('drop-zone-active'); label.style.borderColor = ''; }));

        label.addEventListener('drop', (e) => {
            if(e.dataTransfer.files.length) { 
                input.files = e.dataTransfer.files; 
                input.dispatchEvent(new Event('change')); 
            }
        });

        input.addEventListener('change', () => {
            if(input.files.length) {
                display.textContent = "Processing " + input.files[0].name + "...";
                display.style.color = 'var(--brand-primary)';
                htmx.trigger(form, 'submit'); // Auto-Submit
            }
        });
    }

    setupAutoDrop('blur-drop-area', 'blur-drop-zone', 'blur-file-input', 'blur-file-name', 'blur-upload-form');
    setupAutoDrop('analytics-drop-area', 'analytics-drop-zone', 'analytics-file-input', 'analytics-file-name', 'analytics-upload-form');
})();
</script>