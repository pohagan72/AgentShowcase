{# features/translation/templates/translation_content.html #}
<div class="feature-container translation-feature-container">
    <h1><i class="fas fa-language"></i> Native File Translation</h1>
    <p class="feature-description">
        Upload a Word, PowerPoint or Excel file to have the content translated. This AI Agent will detect the source language and then use GenAI to translate into your chosen language.
    </p>

    {% if not gcs_available or not gemini_configured %}
        <div class="error-message" style="margin-bottom: 20px;">
            <strong>Configuration Issue:</strong>
            {% if not gcs_available %}Google Cloud Storage is not available. {% endif %}
            {% if not gemini_configured %}Google Gemini AI is not configured. {% endif %}
            File processing for translation is disabled. Please check server logs and environment variable settings.
        </div>
    {% endif %}

    <form method="POST" action="{{ url_for('process_translate_document') }}" enctype="multipart/form-data"
          hx-post="{{ url_for('process_translate_document') }}"
          hx-target="#main-content"
          hx-swap="innerHTML"
          hx-encoding="multipart/form-data"
          hx-indicator="#translation-submit-button">  {# MODIFIED: Target the button itself as indicator #}
        
        <div class="form-group">
            <label for="translation-file-input">Upload File (.docx, .pptx, .xlsx):</label>
            <label for="translation-file-input" id="translation-drop-zone-label" class="drop-zone-style">
                <p>Drop .docx, .pptx, .xlsx file here, or click to select.</p>
                <p id="translation-file-name-display">No file selected</p>
            </label>
            <input type="file" id="translation-file-input" name="file" accept=".docx,.pptx,.xlsx" required>
        </div>

        <div class="form-group">
            <label for="translation-target-language">Target Language:</label>
            <select id="translation-target-language" name="target_language" required 
                    {% if not gemini_configured %}disabled{% endif %}>
                {% if not languages and gemini_configured %}
                    <option value="" disabled selected>No languages configured</option>
                {% elif not gemini_configured %}
                     <option value="" disabled selected>Gemini Service Not Configured</option>
                {% else %}
                    {% for lang in languages %}
                        <option value="{{ lang }}">{{ lang }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>

        {# MODIFIED: Added htmx-indicator class to the button, spinner inside it #}
        <div class="submit-area">
            <button type="submit" class="submit-button" id="translation-submit-button"
                    {% if not gcs_available or not gemini_configured %}disabled aria-disabled="true" title="Translation service is not fully configured." {% endif %}>
                <i class="fas fa-cogs"></i> Translate File
                <span class="htmx-indicator spinner"></span> {# SPINNER INSIDE BUTTON #}
            </button>
        </div>
    </form>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="translation-messages">
                {% for category, message in messages %}
                    <div class="message-item category-{{ category|default('info') }}" 
                         role="alert">
                        {% if category == 'error' %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% elif category == 'success' %}
                            <i class="fas fa-check-circle"></i>
                        {% elif category == 'warning' %}
                            <i class="fas fa-exclamation-circle"></i>
                        {% else %}
                            <i class="fas fa-info-circle"></i>
                        {% endif %}
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% if file_id %}
        <div class="translation-download-link">
            <a href="{{ url_for('download_translated_file', file_id=file_id) }}" 
               class="submit-button">
               <i class="fas fa-download"></i> Download Translated File
            </a>
            <p>
                Note: Download links are temporary. The file will be removed from storage after a period defined by system policy.
            </p>
        </div>
    {% endif %}
</div>

<script>
// --- Translation Specific JavaScript ---
document.addEventListener('DOMContentLoaded', function() {
    const translationFeatureContainer = document.querySelector('.translation-feature-container');
    if (!translationFeatureContainer) return;

    // --- Drop Zone Logic ---
    const dropZoneLabel = translationFeatureContainer.querySelector('#translation-drop-zone-label');
    const fileInput = translationFeatureContainer.querySelector('#translation-file-input');
    const fileNameDisplay = translationFeatureContainer.querySelector('#translation-file-name-display');

    if (dropZoneLabel && fileInput && fileNameDisplay) {
        // --- Drag and Drop Event Listeners ---
        dropZoneLabel.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZoneLabel.classList.add('drag-over');
            dropZoneLabel.style.borderColor = '#28a745';
        });

        dropZoneLabel.addEventListener('dragleave', () => {
            e.preventDefault();
            dropZoneLabel.classList.remove('drag-over');
            dropZoneLabel.style.borderColor = '#007bff';
        });

        dropZoneLabel.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZoneLabel.classList.remove('drag-over');
            dropZoneLabel.style.borderColor = '#007bff';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                // Manually trigger change event on fileInputPii so its listener updates the display
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);
            }
        });

        // Listener to update file name display
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
                dropZoneLabel.classList.add('file-selected');
                dropZoneLabel.style.borderColor = '#28a745';
            } else {
                fileNameDisplay.textContent = 'No file selected';
                dropZoneLabel.classList.remove('file-selected');
                dropZoneLabel.style.borderColor = '#007bff';
            }
        });

        // Click on drop-zone itself to trigger file input
        dropZoneLabel.addEventListener('click', () => {
            fileInput.click();
        });

    }
});
</script>