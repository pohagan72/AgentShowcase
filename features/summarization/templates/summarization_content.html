<!-- features/summarization/templates/summarization_content.html -->

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* --- SCOPED CSS FOR SUMMARIZATION --- */
    .summarization-wrapper { max-width: 900px; margin: 0 auto; }

    /* 1. HEADER */
    .sum-header { margin-bottom: 2rem; }
    .sum-header h1 { 
        display: flex; align-items: center; gap: 12px; 
        font-size: 1.8rem; margin-bottom: 1rem; color: var(--text-primary); letter-spacing: -0.02em;
    }
    
    /* Image Header Styling */
    .sum-header h1 img {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .sum-header p { font-size: 1.05rem; color: var(--text-secondary); max-width: 700px; line-height: 1.6; }

    /* 2. INFO GRID */
    .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2.5rem; }
    .info-card { 
        background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; 
        transition: all 0.2s ease; display: flex; flex-direction: column; gap: 0.5rem;
    }
    .info-card:hover { background: #ffffff; border-color: var(--brand-primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
    
    .info-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 0.25rem; }
    .info-card-header i { font-size: 1.4rem; color: var(--brand-primary); flex-shrink: 0; }
    .info-card-header span { font-weight: 700; font-size: 1rem; color: var(--text-primary); }
    .info-card p { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.5; margin: 0; }

    /* 3. CONTROL PANEL */
    .control-panel {
        background: #ffffff;
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        overflow: hidden;
        margin-bottom: 2rem;
        display: flex; flex-direction: column;
    }

    /* Section A: Speed Demo (Top Bar) */
    .cp-demo-bar {
        background: linear-gradient(to right, #f0fdf4, #ffffff);
        border-bottom: 1px solid #dcfce7;
        padding: 1rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }
    .demo-label { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: #15803d; }
    .demo-btn {
        background: #ffffff; border: 1px solid #bbf7d0; color: #166534;
        padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600;
        cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .demo-btn:hover { background: #dcfce7; border-color: #86efac; }

    /* Section B: Upload Area */
    .cp-upload-area {
        background: #f8fafc; padding: 3rem 2rem;
        transition: background 0.2s; 
    }
    .drop-zone-active { background: #eff6ff !important; }

    .upload-label {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        width: 100%;
        border: 2px dashed #cbd5e1; border-radius: 8px; padding: 4rem 2rem; /* Larger touch target */
        text-align: center; cursor: pointer; background: white; transition: all 0.2s;
    }
    .upload-label:hover { border-color: var(--brand-primary); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
    .upload-label i { font-size: 3.5rem; color: #94a3b8; margin-bottom: 1.5rem; transition: color 0.2s; }
    .upload-label h5 { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; margin-top: 0; }
    .upload-label .subtext { font-size: 0.95rem; color: var(--text-secondary); }

    /* 4. DELIBERATION WORKBENCH (The "Matrix" UI) */
    .deliberation-workbench {
        display: none; flex-direction: column;
        background: #0d1117; 
        border: 1px solid #30363d; border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", monospace;
        color: #c9d1d9; margin-bottom: 2rem;
        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .dw-header {
        padding: 12px 20px; background: #161b22; border-bottom: 1px solid #30363d;
        display: flex; justify-content: space-between; align-items: center;
    }
    .dw-title { font-size: 0.85rem; font-weight: 700; color: #e6edf3; display: flex; align-items: center; gap: 8px; }
    .dw-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; min-height: 300px; max-height: 450px; }
    .dw-col { border-right: 1px solid #30363d; display: flex; flex-direction: column; }
    .dw-col:last-child { border-right: none; }
    .dw-col-head { padding: 10px 15px; font-size: 0.7rem; text-transform: uppercase; color: #8b949e; font-weight: 600; border-bottom: 1px solid #30363d; background: rgba(22, 27, 34, 0.95); }
    .dw-content { padding: 15px; overflow-y: auto; flex: 1; font-size: 0.8rem; display: flex; flex-direction: column; gap: 10px; }
    
    /* Workbench Items */
    .hypo-item { padding: 10px; border: 1px solid #30363d; border-radius: 4px; line-height: 1.4; color: #8b949e; }
    .hypo-item.active { border-color: #58a6ff; color: #c9d1d9; background: rgba(56, 139, 253, 0.1); }
    .decision-item { border-left: 3px solid #238636; padding-left: 10px; color: #e6edf3; }

    /* Final Report */
    .report-card { background: white; padding: 3rem; border-radius: 12px; border: 1px solid var(--border-subtle); box-shadow: var(--shadow-lg); }
    .report-prose h1, .report-prose h2 { border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; margin-top: 1.5rem; }
    .report-prose ul { padding-left: 1.2rem; }
    .report-prose li { margin-bottom: 0.5rem; color: #374151; }

    /* RESPONSIVE FIXES (Mobile Matrix) */
    @media (max-width: 768px) {
        .info-grid { grid-template-columns: 1fr; }
        
        /* Stack the Matrix vertically on mobile */
        .dw-grid {
            grid-template-columns: 1fr !important;
            min-height: auto;
            max-height: none !important;
        }
        .dw-col {
            border-right: none !important;
            border-bottom: 1px solid #30363d;
            height: auto;
            max-height: 250px; /* Cap height per section */
        }
        .dw-content {
            height: 150px;
        }
        .dw-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
    }
</style>

<div class="summarization-wrapper feature-container">
    
    <!-- 1. HEADER -->
    <div class="sum-header">
        <h1>
            <img src="{{ url_for('static', filename='images/synzo-executive-briefer-icon.png') }}" 
                 alt="Icon" 
                 style="width: 48px; height: 48px; vertical-align: middle; margin-right: 12px;">
            The Executive Briefer
        </h1>
        
        <!-- Tab Navigation -->
        <div class="feature-tabs">
            <button class="tab-link active" data-target-tab="text-summary-tab">
                <img src="{{ url_for('static', filename='images/tab-icon-text.png') }}" class="tab-icon-img" alt="Text">
                Text Brief
            </button>
            <button class="tab-link" data-target-tab="ppt-summary-tab">
                <img src="{{ url_for('static', filename='images/tab-icon-ppt.png') }}" class="tab-icon-img" alt="PPT">
                PowerPoint Deck
            </button>
        </div>
    </div>

    <!-- ================= TEXT SUMMARY TAB ================= -->
    <div id="text-summary-tab" class="feature-tab-content active-content">
        
        <!-- Info Grid -->
        <div class="info-grid" id="input-info-text">
            <div class="info-card">
                <div class="info-card-header">
                    <i class="ph ph-brain"></i>
                    <span>Smart Classification</span>
                </div>
                <p>Identifies document type (e.g., "10-K", "Legal Contract") to select the correct expert mandate.</p>
            </div>
            <div class="info-card">
                <div class="info-card-header">
                    <i class="ph ph-gavel"></i>
                    <span>Decision Focused</span>
                </div>
                <p>Produces specific "Go/No-Go" judgments and risk assessments, not just summaries.</p>
            </div>
            <div class="info-card">
                <div class="info-card-header">
                    <i class="ph ph-list-checks"></i>
                    <span>Structured Brief</span>
                </div>
                <p>Outputs a strict "Hypotheses → Evidence → Decision" format for executive review.</p>
            </div>
        </div>

        <!-- INPUT PANEL -->
        <div id="input-panel-text">
            <form id="text-summary-form" onsubmit="event.preventDefault();">
                <div class="control-panel">
                    
                    <!-- Speed Demo Bar -->
                    <div class="cp-demo-bar">
                        <div class="demo-label">
                            <i class="ph ph-lightning" style="color: #15803d; font-weight: bold; font-size: 1.1rem;"></i>
                            <span><strong>Speed Demo:</strong> Analyze a complex financial report in seconds.</span>
                        </div>
                        <button type="button" onclick="submitRealAnalysisText(true)" class="demo-btn">
                            Load IBM 2024 Report <i class="ph ph-arrow-right"></i>
                        </button>
                    </div>

                    <!-- Upload Area -->
                    <div class="cp-upload-area" id="text-drop-area">
                        <label for="text-summary-file-input" class="upload-label" id="text-drop-zone">
                            <i class="ph ph-file-doc"></i>
                            <h5 id="text-file-name">Click to upload or drag and drop</h5>
                            <span class="subtext">Drop file to start analysis immediately</span>
                            <div class="file-badges" style="margin-top: 1rem; display: flex; gap: 8px;">
                                <span style="background: #f1f5f9; color: #64748b; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">PDF</span>
                                <span style="background: #f1f5f9; color: #64748b; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">DOCX</span>
                            </div>
                        </label>
                        <input type="file" id="text-summary-file-input" name="file" accept=".docx,.pptx,.xlsx,.pdf" style="display: none;">
                    </div>
                </div>
            </form>
            <div id="error-display-text" class="message-item category-error" style="display:none;"></div>
        </div>

        <!-- DELIBERATION WORKBENCH (Hidden Initially) -->
        <div id="deliberation-ui-text" class="deliberation-workbench">
            <div class="dw-header">
                <div class="dw-title">
                    <i class="ph ph-cpu" style="color: #58a6ff;"></i> ANALYST ENGINE
                    <span style="opacity: 0.3; margin: 0 8px;">|</span> 
                    <span style="font-weight: 400; color: #8b949e;">TASK ID: #<span class="task-id-display">...</span></span>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="dw-status status-text" style="font-size: 0.8rem; letter-spacing: 0.5px; color: #58a6ff;">INITIALIZING...</div>
                    <button class="btn-reveal-result submit-button" style="display:none; height: 32px; font-size: 0.8rem; background: #238636;" onclick="revealFinalResult('text')">
                        View Brief <i class="ph ph-arrow-right"></i>
                    </button>
                </div>
            </div>
            <div class="dw-grid">
                <div class="dw-col"><div class="dw-col-head">Hypotheses</div><div class="dw-content col-hypotheses"></div></div>
                <div class="dw-col"><div class="dw-col-head">Evidence</div><div class="dw-content col-evidence"></div></div>
                <div class="dw-col"><div class="dw-col-head">Decisions</div><div class="dw-content col-decisions"></div></div>
            </div>
        </div>

        <!-- FINAL REPORT (Hidden Initially) -->
        <div id="final-result-wrapper-text" style="display: none; opacity: 0; transition: opacity 0.5s ease;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div id="persona-badge-text" style="background: #eff6ff; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; color: #4f46e5; border: 1px solid #c7d2fe; display: flex; align-items: center; gap: 8px;">
                    <i class="ph ph-user-focus"></i> Active Mandate: <strong>Loading...</strong>
                </div>
                <button onclick="resetView('text')" class="btn-secondary">
                    Analyze Another
                </button>
            </div>
            <div id="summary-output-container" class="report-card report-prose markdown-body"></div>
        </div>
    </div>

    <!-- ================= PPT TAB ================= -->
    <div id="ppt-summary-tab" class="feature-tab-content">
        
        <div class="info-grid">
             <div class="info-card">
                <div class="info-card-header"><i class="ph ph-presentation"></i><span>Storytelling</span></div>
                <p>Converts raw documents into a coherent 5-slide narrative arc automatically.</p>
            </div>
            <div class="info-card">
                <div class="info-card-header"><i class="ph ph-paint-brush"></i><span>Design Engine</span></div>
                <p>Selects layouts, colors, and typography based on the chosen professional template.</p>
            </div>
            <div class="info-card">
                <div class="info-card-header"><i class="ph ph-export"></i><span>Native Export</span></div>
                <p>Delivers an editable .pptx file with speaker notes and semantic slide structures.</p>
            </div>
        </div>

        <div id="input-panel-ppt">
             <form id="ppt-form" onsubmit="event.preventDefault();">
                <div class="control-panel">
                    
                    <!-- Demo Bar -->
                    <div class="cp-demo-bar" style="background: linear-gradient(to right, #fff1f2, #ffffff); border-bottom-color: #fecdd3;">
                         <div class="demo-label" style="color: #be123c;">
                            <i class="ph ph-sparkle" style="color: #f43f5e; font-weight: bold; font-size: 1.1rem;"></i>
                            <span><strong>Magic Demo:</strong> Turn the IBM Report into a pitch deck.</span>
                        </div>
                        <button type="button" onclick="submitPPTStream(true)" class="demo-btn" style="color: #be123c; border-color: #fecdd3;">
                            Create Deck <i class="ph ph-magic-wand"></i>
                        </button>
                    </div>

                    <!-- Upload -->
                     <div class="cp-upload-area" id="ppt-drop-area">
                        <label for="ppt-builder-file-input" class="upload-label" id="ppt-drop-zone">
                            <i class="ph ph-file-ppt"></i>
                            <h5 id="ppt-file-name">Click to upload or drag and drop</h5>
                            <span class="subtext">Drop file to generate deck immediately</span>
                        </label>
                        <input type="file" id="ppt-builder-file-input" name="file" accept=".docx,.pdf" multiple style="display: none;">
                    </div>
                </div>
            </form>
            <div id="error-display-ppt" class="message-item category-error" style="display:none;"></div>
        </div>

        <div id="ppt-progress-wrapper" style="display:none; margin-top: 2rem;">
             <div id="ppt-status-log" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', monospace; font-size: 0.85rem; color: #475569; max-height: 250px; overflow-y: auto;"></div>
             <div id="ppt-result-container" style="margin-top: 1.5rem;"></div>
             <button id="ppt-reset-btn" onclick="resetView('ppt')" class="btn-secondary" style="margin-top:1rem; display:none;">Create Another</button>
        </div>
    </div>
</div>

<script>
    // --- UTILS ---
    let fullTextBuffer = ""; 
    
    // --- UI HELPERS (Pure functionality) ---
    // Updated signature to accept a 'callback' function for auto-submit
    function setupDropZone(areaId, labelId, inputId, displayId, iconClass, callback) {
        const area = document.getElementById(areaId);
        const label = document.getElementById(labelId);
        const input = document.getElementById(inputId);
        const display = document.getElementById(displayId);

        if(!label || !input) return;

        ['dragenter', 'dragover'].forEach(eName => {
            label.addEventListener(eName, (e) => { e.preventDefault(); area.classList.add('drop-zone-active'); label.style.borderColor = 'var(--brand-primary)'; });
        });
        ['dragleave', 'drop'].forEach(eName => {
            label.addEventListener(eName, (e) => { e.preventDefault(); area.classList.remove('drop-zone-active'); label.style.borderColor = ''; });
        });

        label.addEventListener('drop', (e) => {
            e.preventDefault();
            if(e.dataTransfer.files.length) { 
                input.files = e.dataTransfer.files; 
                input.dispatchEvent(new Event('change')); 
            }
        });

        // AUTO-SUBMIT LOGIC:
        input.addEventListener('change', () => {
            if(input.files.length) {
                // Update UI visually
                display.textContent = "Analyzing " + input.files[0].name + "...";
                display.style.color = 'var(--brand-primary)';
                const icon = label.querySelector('i');
                if(icon) { icon.className = `ph ph-spinner ph-spin`; icon.style.color = 'var(--brand-primary)'; }
                
                // EXECUTE THE ACTION IMMEDIATELY
                if (typeof callback === 'function') {
                    callback();
                }
            }
        });
    }

    // --- INIT ---
    (function() {
        // Initialize Text Brief Drop Zone with Auto-Submit
        setupDropZone(
            'text-drop-area', 
            'text-drop-zone', 
            'text-summary-file-input', 
            'text-file-name', 
            'ph-file-text',
            function() { submitRealAnalysisText(false); } // Callback
        );

        // Initialize PPT Drop Zone with Auto-Submit
        setupDropZone(
            'ppt-drop-area', 
            'ppt-drop-zone', 
            'ppt-builder-file-input', 
            'ppt-file-name', 
            'ph-file-ppt',
            function() { submitPPTStream(false); } // Callback
        );
    })();

    // --- LOGIC: TEXT SUMMARY ---
    async function submitRealAnalysisText(useSample) {
        const context = 'text';
        document.getElementById('input-panel-text').style.display = 'none';
        document.getElementById('input-info-text').style.display = 'none'; // Hide grid to focus
        document.getElementById('deliberation-ui-text').style.display = 'flex';
        resetDeliberationUI(context);

        const formData = new FormData();
        if (useSample) formData.append("use_sample", "true");
        else {
            const fi = document.getElementById('text-summary-file-input');
            if(fi.files.length) formData.append("file", fi.files[0]);
        }

        try {
            const response = await fetch("{{ url_for('summarization.process_summarize') }}", { method: "POST", body: formData });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            while(true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split("\n");
                buffer = lines.pop();

                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const msg = JSON.parse(line);
                        if (msg.type === "meta") {
                            document.querySelector('#persona-badge-text strong').innerText = msg.role;
                            updateStatus(context, "ANALYZING STRUCTURE...");
                        } else if (msg.type === "chunk") {
                            fullTextBuffer += msg.content;
                            updateThinkingAndReport(context);
                        } else if (msg.type === "error") throw new Error(msg.content);
                    } catch(e) {}
                }
            }
            finishDeliberationText(context);
        } catch(e) { handleError(e, context); }
    }

    // --- LOGIC: PPT GENERATION ---
    async function submitPPTStream(useSample) {
        document.getElementById('input-panel-ppt').style.display = 'none';
        const prog = document.getElementById('ppt-progress-wrapper');
        prog.style.display = 'block';
        const log = document.getElementById('ppt-status-log');
        log.innerHTML = '<div><i class="ph ph-spinner ph-spin"></i> Initializing Designer Agent...</div>';

        const formData = new FormData();
        if(useSample) formData.append("use_sample", "true");
        else {
             const fi = document.getElementById('ppt-builder-file-input');
             if(fi.files.length) formData.append("file", fi.files[0]);
        }
        
        try {
            const response = await fetch("{{ url_for('summarization.process_create_ppt') }}", { method: "POST", body: formData });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";

            while(true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split("\n");
                buffer = lines.pop();
                
                for(const line of lines) {
                    if(!line.trim()) continue;
                    try {
                        const msg = JSON.parse(line);
                        if(msg.type === "status") {
                            log.innerHTML += `<div><i class="ph ph-check" style="color:#22c55e"></i> ${msg.message}</div>`;
                            log.scrollTop = log.scrollHeight;
                        } else if(msg.type === "result") {
                            document.getElementById('ppt-result-container').innerHTML = msg.html;
                            document.getElementById('ppt-reset-btn').style.display = 'block';
                        }
                    } catch(e) {}
                }
            }
        } catch(e) { log.innerHTML += `<div style="color:red">Error: ${e}</div>`; document.getElementById('ppt-reset-btn').style.display = 'block'; }
    }

    // --- HELPERS ---
    function updateThinkingAndReport(context) {
        const marker = "### REPORT START";
        const splitIndex = fullTextBuffer.indexOf(marker);
        let thinking = splitIndex === -1 ? fullTextBuffer : fullTextBuffer.substring(0, splitIndex);
        let report = splitIndex !== -1 ? fullTextBuffer.substring(splitIndex + marker.length) : "";
        
        const regex = /::\s*(HYPO|HYPOTHESIS|EVIDENCE|DECISION|NOTE)\s*::/gi;
        let match;
        const ui = document.getElementById(`deliberation-ui-${context}`);
        
        ui.querySelector('.col-hypotheses').innerHTML = '';
        ui.querySelector('.col-evidence').innerHTML = '';
        ui.querySelector('.col-decisions').innerHTML = '';

        let tags = [];
        while ((match = regex.exec(thinking)) !== null) {
             tags.push({ type: match[1].toUpperCase(), idx: match.index, end: match.index + match[0].length });
        }

        for(let i=0; i<tags.length; i++) {
            let nextStart = (i+1 < tags.length) ? tags[i+1].idx : thinking.length;
            let content = thinking.substring(tags[i].end, nextStart).trim();
            if(!content) continue;
            
            if(tags[i].type.includes('HYPO')) appendItem(ui.querySelector('.col-hypotheses'), content, 'hypo-item active');
            else if(tags[i].type.includes('EVI')) appendItem(ui.querySelector('.col-evidence'), content, 'hypo-item');
            else if(tags[i].type.includes('DEC')) appendItem(ui.querySelector('.col-decisions'), content, 'decision-item');
        }

        if(report) {
            document.getElementById('summary-output-container').innerHTML = marked.parse(report);
            updateStatus(context, "FINALIZING BRIEF...");
        }
    }

    function appendItem(col, html, cls) {
        const d = document.createElement('div'); d.className = cls; d.innerText = html; col.appendChild(d);
        col.scrollTop = col.scrollHeight;
    }

    function updateStatus(c, t) { document.querySelector(`#deliberation-ui-${c} .status-text`).innerText = t; }
    
    function finishDeliberationText(c) {
        updateStatus(c, "COMPLETE");
        document.querySelector(`#deliberation-ui-${c} .btn-reveal-result`).style.display = 'inline-flex';
    }

    window.revealFinalResult = function(c) {
        document.getElementById(`deliberation-ui-${c}`).style.display = 'none';
        const res = document.getElementById(`final-result-wrapper-${c}`);
        res.style.display = 'block';
        setTimeout(() => res.style.opacity = '1', 10);
    }
    
    function resetDeliberationUI(c) {
        fullTextBuffer = "";
        document.querySelector('.task-id-display').innerText = Math.floor(Math.random()*9999);
        ['col-hypotheses','col-evidence','col-decisions'].forEach(cls => document.querySelector(`.${cls}`).innerHTML='');
    }

    window.resetView = function(c) { location.reload(); }
    
    function handleError(e, c) {
        document.getElementById(`input-panel-${c}`).style.display = 'block';
        document.getElementById(`deliberation-ui-${c}`).style.display = 'none';
        alert("Error: " + e.message);
    }
</script>