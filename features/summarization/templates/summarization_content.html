<!-- features/summarization/templates/summarization_content.html -->

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* --- Base Feature Styles --- */
    .summarization-feature-container .feature-description { margin-bottom: 2rem; color: var(--text-secondary); font-size: 1.05rem; line-height: 1.6; }
    .summarization-feature-container .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
    .summarization-feature-container .feature-item { background: #ffffff; padding: 1.5rem; border-radius: var(--radius-md); border: 1px solid var(--border-subtle); transition: transform 0.2s, box-shadow 0.2s; }
    .summarization-feature-container .feature-item:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: var(--brand-primary); }
    .summarization-feature-container .feature-item h4 { margin: 0 0 0.5rem 0; font-family: var(--font-sans); font-size: 1rem; color: var(--text-primary); font-weight: 600; }
    .summarization-feature-container .feature-item p { font-family: var(--font-sans); color: var(--text-secondary); line-height: 1.5; margin: 0; font-size: 0.9rem; }

    /* --- Flash Demo Card --- */
    .flash-demo-card { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 2rem; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 1rem; }
    .flash-demo-card strong { color: #15803d; font-size: 1.05rem; display: block; margin-bottom: 0.2rem; }
    .flash-demo-card span { color: #166534; font-size: 0.9rem; }

    /* --- Error Banner --- */
    .error-banner { background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; }

    /* --- V2 DELIBERATION WORKBENCH STYLES --- */
    .deliberation-workbench {
        display: none; /* Hidden initially */
        background: #0d1117; /* GitHub Dark Dimmed */
        border: 1px solid #30363d;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        overflow: hidden;
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        flex-direction: column;
        width: 100%;
        animation: slideUp 0.3s ease-out;
        color: #c9d1d9;
    }

    .dw-header {
        padding: 12px 20px;
        border-bottom: 1px solid #30363d;
        background: #161b22;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 60px;
        flex-shrink: 0;
    }
    .dw-title { 
        color: #e6edf3; font-weight: 700; font-size: 0.85rem; 
        display: flex; gap: 10px; align-items: center; 
    }
    .dw-status { color: #58a6ff; font-size: 0.8rem; letter-spacing: 0.5px; }

    .dw-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        min-height: 300px;
        max-height: 450px;
        background: #0d1117;
    }

    .dw-col {
        border-right: 1px solid #30363d;
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }
    .dw-col:last-child { border-right: none; }

    .dw-col-head {
        padding: 10px 15px;
        font-size: 0.7rem;
        text-transform: uppercase;
        color: #8b949e;
        letter-spacing: 1px;
        font-weight: 600;
        border-bottom: 1px solid #30363d;
        background: rgba(22, 27, 34, 0.9);
        flex-shrink: 0;
    }

    .dw-content {
        padding: 15px;
        overflow-y: auto;
        flex: 1;
        font-size: 0.8rem;
        display: flex;
        flex-direction: column;
        gap: 12px;
        scrollbar-width: thin;
        scrollbar-color: #30363d #0d1117;
    }

    /* Items inside columns */
    .hypo-item { padding: 12px; border: 1px solid #30363d; border-radius: 4px; color: #c9d1d9; transition: all 0.5s ease; opacity: 0; animation: fadeIn 0.5s forwards; line-height: 1.4; }
    .hypo-item.active { border-color: #58a6ff; background: rgba(56, 139, 253, 0.1); }
    .evidence-item { color: #8b949e; border-left: 3px solid #238636; padding-left: 12px; opacity: 0; animation: fadeIn 0.5s forwards; line-height: 1.4; }
    .evidence-item strong { color: #e6edf3; display: block; margin-bottom: 3px;}
    .evidence-item.positive { border-color: #238636; }
    .decision-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 4px; border-left: 4px solid #58a6ff; opacity: 0; animation: slideInRight 0.5s forwards; color: #ffffff !important; line-height: 1.4; }
    .decision-item.final { border-color: #238636; background: rgba(46, 160, 67, 0.1); }

    /* Footer */
    .dw-footer {
        padding: 15px 20px;
        border-top: 1px solid #30363d;
        background: #161b22;
        flex-shrink: 0;
    }
    .analyst-note-title { color: #d29922; font-size: 0.75rem; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .analyst-note-body { color: #8b949e; font-size: 0.85rem; line-height: 1.5; }

    /* Animations */
    @keyframes fadeIn { to { opacity: 1; } }
    @keyframes slideInRight { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes pulse-green-glow { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
    .pulse-button { animation: pulse-green-glow 2s infinite; }

    /* PPT STATUS LOG */
    .ppt-status-log {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        color: #475569;
        margin-top: 1.5rem;
        display: none; /* Hidden by default */
    }
    .ppt-log-line { margin-bottom: 0.5rem; display: flex; align-items: center; gap: 8px; animation: fadeIn 0.3s forwards; }
    .ppt-log-line i { color: #22c55e; }

    /* Document Styles */
    .summary-display-box h1 { font-size: 1.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; margin-top: 1.5rem; }
    .summary-display-box h2 { font-size: 1.25rem; color: var(--brand-primary); margin-top: 1.5rem; font-weight: 700; }
    .summary-display-box h3 { font-size: 1.1rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-top: 2rem; font-weight: 600; }
    .summary-display-box ul { margin-bottom: 1.5rem; padding-left: 1.5rem; }
    .summary-display-box li { margin-bottom: 0.5rem; color: #334155; }
    .summary-display-box strong { color: #0f172a; font-weight: 600; }
    
    @media (max-width: 768px) {
        .dw-grid { grid-template-columns: 1fr; max-height: none; }
        .dw-col { border-right: none; border-bottom: 1px solid #30363d; height: 200px; }
    }
</style>

<div class="feature-container summarization-feature-container">
    <h1><i class="fas fa-briefcase"></i> The Executive Briefer</h1>

    <div class="feature-tabs">
        <button class="tab-link active" data-target-tab="text-summary-tab"><i class="fas fa-align-left"></i> Create Text Summary</button>
        <button class="tab-link" data-target-tab="ppt-summary-tab"><i class="fas fa-file-powerpoint"></i> Create Executive PowerPoint</button>
    </div>

    <!-- ================= TEXT SUMMARY TAB ================= -->
    <div id="text-summary-tab" class="feature-tab-content active-content">
        <div id="input-panel-text">
            <p class="feature-description">AI Agent with "Expert Personas" (CFO, Legal, Tech).</p>
            <div class="flash-demo-card">
                <div><strong>ðŸš€ Speed Demo:</strong><span>Analyze IBM 2024 Report.</span></div>
                <button onclick="submitRealAnalysisText(true)" class="submit-button" style="margin:0; background:#16a34a;"><i class="fas fa-bolt"></i> Load Report</button>
            </div>
            <form id="text-summary-form" onsubmit="event.preventDefault(); submitRealAnalysisText(false);">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="text-summary-file-input" id="text-summary-drop-zone-label" class="drop-zone-style">
                        <i class="fas fa-file-alt"></i>
                        <div><p>Click to upload (PDF, DOCX)</p></div>
                    </label>
                    <input type="file" id="text-summary-file-input" name="file" accept=".docx,.pptx,.xlsx,.pdf" style="display: none;">
                </div>
                <button type="submit" id="text-summary-submit-btn" class="submit-button" disabled>Generate Analysis</button>
            </form>
        </div>

        <div id="deliberation-ui-text" class="deliberation-workbench">
            <div class="dw-header">
                <div class="dw-title" style="color:white; font-weight:700;">ANALYST ENGINE</div>
                <div style="display:flex; gap:15px; align-items:center;">
                    <div class="dw-status status-text" style="color:#58a6ff;">INITIALIZING...</div>
                    <button class="btn-reveal-result submit-button" style="display:none; background:#22c55e;" onclick="revealFinalResult('text')">View Final Brief</button>
                </div>
            </div>
            <div class="dw-grid">
                <div class="dw-col"><div class="dw-col-head">Hypotheses</div><div class="dw-content col-hypotheses"></div></div>
                <div class="dw-col"><div class="dw-col-head">Evidence</div><div class="dw-content col-evidence"></div></div>
                <div class="dw-col"><div class="dw-col-head">Decisions</div><div class="dw-content col-decisions"></div></div>
            </div>
            <div class="dw-footer">
                <div class="analyst-note-title" style="color:#d29922; font-weight:700;">Analyst Notes</div>
                <div class="analyst-note-body dw-notes" style="color:#8b949e;">Pending...</div>
            </div>
        </div>

        <div id="final-result-wrapper-text" style="display: none; opacity: 0; transition: opacity 0.5s ease;">
             <div class="summary-actions" style="margin-bottom: 1.5rem; display: flex; justify-content: flex-end;">
                <button onclick="resetView('text')" class="btn-secondary" style="background: white; border: 1px solid #e2e8f0; color: #64748b; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                    <i class="fas fa-undo"></i> Analyze Another Document
                </button>
            </div>
            <div id="summary-output-container" class="summary-display-box" style="background:white; padding:2rem; border-radius:8px; border:1px solid #e5e7eb;"></div>
        </div>
    </div>

    <!-- ================= PPT TAB (Streaming) ================= -->
    <div id="ppt-summary-tab" class="feature-tab-content">
        <div id="input-panel-ppt">
            <p class="feature-description">Transforms documents into executive presentations.</p>
            <div class="flash-demo-card" style="border-color: #fecdd3; background: #fff1f2;">
                <div><strong style="color: #9f1239;">âœ¨ Magic Demo:</strong><span style="color: #be123c;">Generate IBM Deck.</span></div>
                <button onclick="submitPPTStream(true)" class="submit-button" style="margin: 0; background: #e11d48;"><i class="fas fa-magic"></i> Create Deck</button>
            </div>
            
            <form id="ppt-form" onsubmit="event.preventDefault(); submitPPTStream(false);">
                <input type="hidden" name="inputType" value="file">
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="ppt-file-input" id="ppt-drop-zone" class="drop-zone-style">
                        <i class="fas fa-file-powerpoint"></i><div><p>Upload for PPT (DOCX, PDF)</p></div>
                    </label>
                    <input type="file" id="ppt-file-input" name="file" accept=".docx,.pdf" style="display:none;">
                </div>
                <button type="submit" id="ppt-btn" class="submit-button">Generate Presentation</button>
            </form>
        </div>

        <div id="ppt-progress-wrapper" style="display:none;">
             <!-- STATUS LOG -->
             <div id="ppt-status-log" class="ppt-status-log"></div>
             <!-- RESULT -->
             <div id="ppt-result-container" style="margin-top: 1.5rem;"></div>
             <!-- RESET -->
             <button id="ppt-reset-btn" onclick="resetView('ppt')" class="btn-secondary" style="margin-top:1rem; display:none; background:white; border:1px solid #ddd; padding:8px 16px; border-radius:6px; cursor:pointer;">Create Another</button>
        </div>
    </div>
</div>

<script>
    // --- TEXT SUMMARY LOGIC ---
    let reportBuffer = "", thinkingBuffer = "", isReport = false;

    async function submitRealAnalysisText(useSample) {
        document.getElementById('input-panel-text').style.display = 'none';
        document.getElementById('deliberation-ui-text').style.display = 'flex';
        resetUI('text');

        const formData = new FormData();
        if (useSample) formData.append("use_sample", "true");
        else {
            const fi = document.getElementById('text-summary-file-input');
            if(fi.files.length) formData.append("file", fi.files[0]);
        }

        try {
            const resp = await fetch("{{ url_for('summarization.process_summarize') }}", { method: "POST", body: formData });
            const reader = resp.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const lines = decoder.decode(value, {stream:true}).split("\n");
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const msg = JSON.parse(line);
                        if (msg.type === "chunk") {
                            const txt = msg.content;
                            if (txt.includes("### REPORT START")) {
                                isReport = true;
                                document.querySelector('.status-text').innerText = "GENERATING BRIEF...";
                                const parts = txt.split("### REPORT START");
                                if (parts[0]) parseThinking(parts[0]);
                                if (parts[1]) reportBuffer += parts[1];
                            } else if (isReport) reportBuffer += txt;
                            else parseThinking(txt);
                        }
                    } catch(e) {}
                }
            }
            finishText();
        } catch (e) { console.error(e); }
    }

    function parseThinking(text) {
        thinkingBuffer += text;
        const regex = /::\s*(HYPO|EVIDENCE|DECISION|NOTE)\s*::(.*?)(?=(::|$))/gis;
        let match;
        while ((match = regex.exec(thinkingBuffer)) !== null) {
            addItem('text', match[1].toLowerCase(), match[2].trim());
        }
    }

    function addItem(ctx, type, text) {
        const ui = document.getElementById(`deliberation-ui-${ctx}`);
        let col, el = document.createElement('div');
        if (type.includes('hypo')) { col = ui.querySelector('.col-hypotheses'); el.className = 'hypo-item active'; }
        else if (type.includes('evi')) { col = ui.querySelector('.col-evidence'); el.className = 'evidence-item'; text = `+ ${text}`; }
        else if (type.includes('dec')) { col = ui.querySelector('.col-decisions'); el.className = 'decision-item final'; text = `âœ“ ${text}`; }
        else if (type.includes('note')) { ui.querySelector('.dw-notes').innerText = text; return; }
        
        if(col) { el.innerText = text; col.appendChild(el); col.scrollTop = col.scrollHeight; }
    }

    function finishText() {
        const ui = document.getElementById('deliberation-ui-text');
        ui.querySelector('.status-text').innerText = "COMPLETE";
        ui.querySelector('.btn-reveal-result').style.display = 'inline-flex';
        document.getElementById('summary-output-container').innerHTML = marked.parse(reportBuffer);
    }

    window.revealFinalResult = function(ctx) {
        document.getElementById(`deliberation-ui-${ctx}`).style.display = 'none';
        document.getElementById(`final-result-wrapper-${ctx}`).style.display = 'block';
    };

    // --- PPT STREAM LOGIC ---
    async function submitPPTStream(useSample) {
        document.getElementById('input-panel-ppt').style.display = 'none';
        const progressWrapper = document.getElementById('ppt-progress-wrapper');
        progressWrapper.style.display = 'block';
        
        const logDiv = document.getElementById('ppt-status-log');
        logDiv.innerHTML = '';
        logDiv.style.display = 'block';

        const formData = new FormData();
        if (useSample) formData.append("use_sample", "true");
        else {
            const fi = document.getElementById('ppt-file-input');
            if(fi.files.length) formData.append("file", fi.files[0]);
        }
        formData.append("inputType", "file");

        try {
            const resp = await fetch("{{ url_for('summarization.process_create_ppt') }}", { method: "POST", body: formData });
            const reader = resp.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const lines = decoder.decode(value, {stream:true}).split("\n");
                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const msg = JSON.parse(line);
                        if (msg.type === "status") {
                            logDiv.innerHTML += `<div class="ppt-log-line"><i class="fas fa-chevron-right"></i> ${msg.message}</div>`;
                        } else if (msg.type === "result") {
                            document.getElementById('ppt-result-container').innerHTML = msg.html;
                            document.getElementById('ppt-reset-btn').style.display = 'block';
                        } else if (msg.type === "error") {
                             logDiv.innerHTML += `<div style="color:red"><i class="fas fa-times"></i> ${msg.message}</div>`;
                             document.getElementById('ppt-reset-btn').style.display = 'block';
                        }
                    } catch(e) {}
                }
            }
        } catch (e) {
            logDiv.innerHTML += `<div style="color:red">Connection Error: ${e}</div>`;
            document.getElementById('ppt-reset-btn').style.display = 'block';
        }
    }

    function resetUI(ctx) {
        if (ctx === 'text') {
            const ui = document.getElementById(`deliberation-ui-${ctx}`);
            ui.querySelector('.col-hypotheses').innerHTML = '';
            ui.querySelector('.col-evidence').innerHTML = '';
            ui.querySelector('.col-decisions').innerHTML = '';
            reportBuffer = ""; thinkingBuffer = ""; isReport = false;
        } else {
            // PPT
             document.getElementById('input-panel-ppt').style.display = 'block';
             document.getElementById('ppt-progress-wrapper').style.display = 'none';
             document.getElementById('ppt-result-container').innerHTML = '';
        }
    }

    window.resetView = function(ctx) { 
        if (ctx === 'text') location.reload(); 
        else resetUI(ctx);
    };

    // --- INIT ---
    (function() {
        const container = document.querySelector('.summarization-feature-container');
        if (!container) return;
        const tabLinks = container.querySelectorAll('.feature-tabs .tab-link');
        const tabContents = container.querySelectorAll('.feature-tab-content');
        function openTab(targetId) {
            tabContents.forEach(tc => { tc.style.display = 'none'; tc.classList.remove('active-content'); });
            tabLinks.forEach(tl => tl.classList.remove('active'));
            container.querySelector('#' + targetId).style.display = 'block';
            container.querySelector(`.feature-tabs .tab-link[data-target-tab="${targetId}"]`).classList.add('active');
        }
        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => { e.preventDefault(); openTab(link.dataset.targetTab); });
        });
        if (tabLinks.length > 0) openTab(tabLinks[0].dataset.targetTab);
        
        // Simple file input listeners
        const fi = document.getElementById('text-summary-file-input');
        const lbl = document.getElementById('text-summary-drop-zone-label');
        if(fi && lbl) fi.addEventListener('change', () => lbl.classList.add('file-selected'));
        
        const fi2 = document.getElementById('ppt-file-input');
        const lbl2 = document.getElementById('ppt-drop-zone');
        if(fi2 && lbl2) fi2.addEventListener('change', () => lbl2.classList.add('file-selected'));
    })();
</script>